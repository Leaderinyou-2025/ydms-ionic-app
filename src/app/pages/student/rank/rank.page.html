<app-header
  [pageTitle]="activeTab === 'rank' ? TranslateKeys.TITLE_YOUR_RANK : TranslateKeys.TITLE_YOUR_ACHIEVEMENTS"
  backgroundImageUrl="/assets/images/banner.svg"
  [segment]="segment"
  [animeImage]="animeImage"
  [animation]="animation"
  (changeSegment)="switchTab($event)">
</app-header>

<ion-content [fullscreen]="true" class="font-comic-sans">
  <ion-refresher slot="fixed" mode="md" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Loading spinner -->
  <ion-spinner *ngIf="isLoading" name="crescent"
               class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></ion-spinner>

  <!-- Rank content -->
  <div class="pt-8 h-full" *ngIf="!isLoading && activeTab === 'rank' && leadershipList">
    <!-- Top 3 ranks -->
    <div class="flex justify-around items-end pt-8 px-2.5 relative" *ngIf="leadershipList.length > 0">
      <div class="flex flex-col items-center text-center w-1/3" *ngIf="leadershipList.length > 1 && leadershipList[1]">
        <div class="relative mb-2">
          <ion-img src="/assets/images/rank/trophy_2.png" alt="Silver Medal" class="w-[100px] h-auto block mx-auto mb-1"></ion-img>
          <div class="absolute bottom-[18px] left-0 right-0 text-[#fcefed] font-bold text-[10px] text-center">
            {{ leadershipList[1].total_points }} {{ TranslateKeys.RANK_POINTS | translate }}
          </div>
        </div>
        <div class="flex items-center gap-2">
          <ion-avatar class="w-8 h-8 border border-blue-500">
            <ion-img [src]="leadershipList[1].avatar" alt="Avatar"></ion-img>
          </ion-avatar>
          <div
            class="text-xs font-medium text-gray-800 dark:text-gray-200 whitespace-nowrap overflow-hidden text-ellipsis max-w-[90%]">
            {{ leadershipList[1].nickname }}
          </div>
        </div>
      </div>

      <div class="flex flex-col items-center text-center w-1/3 transform -translate-y-12" *ngIf="leadershipList[0]">
        <div class="relative mb-2">
          <ion-img src="/assets/images/rank/trophy_1.png" alt="Gold Trophy" class="w-[150px] h-auto block mx-auto mb-1"></ion-img>
          <div class="absolute bottom-[25px] left-0 right-0 text-[#fcefed] font-bold text-[10px] text-center">
            {{ leadershipList[0].total_points }} {{ TranslateKeys.RANK_POINTS | translate }}
          </div>
        </div>
        <div class="flex items-center gap-2">
          <ion-avatar class="w-8 h-8 border border-blue-500">
            <ion-img [src]="leadershipList[0].avatar" alt="Avatar"></ion-img>
          </ion-avatar>
          <div
            class="text-xs font-medium text-gray-800 dark:text-gray-200 whitespace-nowrap overflow-hidden text-ellipsis max-w-[90%]">
            {{ leadershipList[0].nickname }}
          </div>
        </div>
      </div>

      <div class="flex flex-col items-center text-center w-1/3" *ngIf="leadershipList.length > 2 && leadershipList[2]">
        <div class="relative mb-2">
          <ion-img src="/assets/images/rank/trophy_3.png" alt="Bronze Medal" class="w-[100px] h-auto block mx-auto mb-1"></ion-img>
          <div class="absolute bottom-[18px] left-0 right-0 text-[#fcefed] font-bold text-[10px] text-center">
            {{ leadershipList[2].total_points }} {{ TranslateKeys.RANK_POINTS | translate }}
          </div>
        </div>
        <div class="flex items-center gap-2">
          <ion-avatar class="w-8 h-8 border border-blue-500">
            <ion-img [src]="leadershipList[2].avatar" alt="Avatar" class=""></ion-img>
          </ion-avatar>
          <div
            class="text-xs font-medium text-gray-800 dark:text-gray-200 whitespace-nowrap overflow-hidden text-ellipsis max-w-[90%]">
            {{ leadershipList[2].nickname }}
          </div>
        </div>
      </div>
    </div>

    <!-- Other ranks -->
    <div class="my-4 flex flex-col h-[calc(100vh-450px)]">
      <div
        class="flex py-2 bg-white dark:bg-gray-800 font-bold text-sm text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-5">
        <div class="w-[15%] text-center">{{ TranslateKeys.RANK_POSITION | translate }}</div>
        <div class="w-[60%] text-left pl-1">{{ TranslateKeys.RANK_NICKNAME | translate }}</div>
        <div class="w-[25%] text-right pr-2.5">{{ TranslateKeys.RANK_POINTS_HEADER | translate }}</div>
      </div>

      <div class="flex-1 overflow-y-auto"
           #rankTableBody
           [class]="shouldShowFixedUserLeadership() && userLeadership ? 'mb-[35px]' : 'mb-[45px]'"
           (scroll)="checkCurrentUserVisibility()">
        <!-- Start loop from the 4th item (index 3) -->
        <div class="flex items-center py-2 px-2.5 border-b border-gray-100 dark:border-gray-700 text-sm"
             [class.bg-blue-400]="item['isCurrentUser']"
             [class.text-gray-800]="item['isCurrentUser']"
             [class.dark:text-gray-800]="item['isCurrentUser']"
             [class.current-user]="item['isCurrentUser']"
             *ngFor="let item of leadershipList.slice(3)"
             [attr.data-user-id]="item?.teenager_id?.id ?? item?.id">
          <div class="w-[15%] text-center font-medium">{{ item.ranking }}</div>
          <div class="w-[60%] flex items-center text-left pl-1">
            <ion-avatar class="w-8 h-8 border border-blue-500 mr-1">
              <ion-img [src]="item.avatar" alt="Avatar"></ion-img>
            </ion-avatar>
            <span class="whitespace-nowrap overflow-hidden text-ellipsis">{{ item?.nickname }}</span>
          </div>
          <div class="w-[25%] text-right font-medium pr-1">{{ item.total_points }}</div>
        </div>

        <!--    Load more rank data    -->
        <ion-infinite-scroll (ionInfinite)="loadMoreRankData($event)">
          <ion-infinite-scroll-content></ion-infinite-scroll-content>
        </ion-infinite-scroll>
      </div>

      <!-- Fixed current user rank at bottom if ranking >= 10 and not yet scrolled to that row -->
      <div class="sticky bottom-0 left-0 right-0 z-10 bg-transparent p-0"
           *ngIf="shouldShowFixedUserLeadership() && userLeadership">
        <div class="flex items-center py-2 px-2.5 text-sm bg-blue-400 text-gray-800 my-1">
          <div class="w-[15%] text-center font-medium">{{ userLeadership.ranking }}</div>
          <div class="w-[60%] flex items-center pl-1">
            <ion-avatar class="w-9 h-9 border border-blue-500">
              <ion-img [src]="userLeadership.avatar" alt="Avatar"></ion-img>
            </ion-avatar>
            <span class="whitespace-nowrap overflow-hidden text-ellipsis">{{ userLeadership.nickname }}</span>
          </div>
          <div class="w-[25%] text-right font-medium pr-1">{{ userLeadership.total_points }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Achievements content -->
  <div class="text-gray-700 dark:text-gray-300" *ngIf="!isLoading && activeTab === 'achievements'">
    <ion-list>
      <ion-item-group *ngFor="let category of achievements">
        <ion-card class="mx-3 my-3 rounded-xl shadow-md overflow-hidden">
          <ion-card-header class="p-1">
            <ion-card-title class="text-base font-bold p-1 text-gray-800 dark:text-gray-200">{{ category.name ? (category.name | translate) : '' }}
            </ion-card-title>
          </ion-card-header>

          <ion-card-content class="p-0 pb-3">
            <div *ngIf="!category['badges'] || category['badges'].length === 0" class="p-4 text-center text-gray-500">
              {{ TranslateKeys.BADGE_NO_ACHIEVEMENTS_YET | translate }}
            </div>

            <ion-grid *ngIf="category['badges'] && category['badges'].length > 0">
              <ion-row>
                <ion-col size="4" *ngFor="let badge of category['badges'] || []">
                  <div
                    class="relative text-center p-1 pt-2 rounded-lg bg-white dark:bg-gray-700 m-1 transition-transform hover:scale-105"
                    [class.opacity-40]="!badge.unlocked"
                    [class.filter-grayscale]="!badge.unlocked">
                    <ion-img [src]="badge.image || 'assets/images/badges/default-badge.png'"
                             class="w-20 h-auto max-h-20 mx-auto block" [alt]="badge.name"></ion-img>
                    <ion-badge *ngIf="badge.isNew"
                               class="absolute top-1 p-0.5 px-1 right-1.5 text-xs z-2 bg-red-500 border border-red-100 text-white rounded">
                      {{ TranslateKeys.BADGE_NEW | translate }}
                    </ion-badge>
                    <div
                      class="font-medium mt-0.5 text-xs text-gray-700 dark:text-gray-300 font-comic-sans">{{ badge.name }}
                    </div>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>
      </ion-item-group>

      <!-- No achievements message -->
      <div *ngIf="achievements.length === 0" class="p-8 text-center">
        <ion-icon name="trophy-outline" class="text-6xl text-gray-400 mb-4"></ion-icon>
        <p class="text-gray-500">{{ TranslateKeys.BADGE_NO_ACHIEVEMENTS_YET | translate }}</p>
      </div>
    </ion-list>
  </div>
</ion-content>

<app-footer></app-footer>
