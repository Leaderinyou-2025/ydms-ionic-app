<ion-header>
  <ion-toolbar class="font-comic-sans bg-gradient-to-b from-purple-600 to-purple-900 text-white">
    <ion-buttons>
      <ion-back-button text="" defaultHref="/" class="text-white ml-1"></ion-back-button>
    </ion-buttons>
    <div class="relative flex items-start justify-between w-full pl-5 pt-1 pb-28">
      <div class="flex-grow">
        <h1 *ngIf="activeTab === 'rank'" class="text-2xl font-semibold text-white m-0 p-0">
          {{ TranslateKeys.TITLE_YOUR_RANK | translate }}
        </h1>
        <h1 *ngIf="activeTab === 'achievements'" class="text-2xl font-semibold text-white m-0 p-0">
          {{ TranslateKeys.TITLE_YOUR_ACHIEVEMENTS | translate }}
        </h1>
      </div>
      <div class="flex-1"></div>
      <div class="absolute -right-12 -bottom-2">
        <img src="assets/images/ranking.png" alt="Character" class="w-[170px] h-auto max-h-[170px] object-contain">
      </div>
    </div>
  </ion-toolbar>
  <!-- Tab navigation -->
  <div class="absolute bottom-1 left-0 right-0 z-10 mx-0.5">
    <ion-segment [value]="activeTab" (ionChange)="switchTab($event.detail.value)" mode="ios" class="bg-white dark:bg-gray-800 rounded">
      <ion-segment-button value="rank" class="font-comic-sans text-sm font-medium">
        {{ TranslateKeys.TITLE_RANK | translate }}
      </ion-segment-button>
      <ion-segment-button value="achievements" class="font-comic-sans text-sm font-medium">
        {{ TranslateKeys.TITLE_ACHIEVEMENTS | translate }}
      </ion-segment-button>
    </ion-segment>
  </div>
</ion-header>

<ion-content [fullscreen]="true" class="font-comic-sans">
  <!-- Loading spinner -->
  <ion-spinner *ngIf="isLoading" name="crescent"
               class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></ion-spinner>

  <!-- Rank content -->
  <div class="pt-8 h-full" *ngIf="!isLoading && activeTab === 'rank'">
    <!-- Top 3 ranks -->
    <div class="flex justify-around items-end pt-8 px-2.5 relative" *ngIf="rankList.length > 0">
      <div class="flex flex-col items-center text-center w-1/3" *ngIf="rankList.length > 1 && rankList[1]">
        <div class="relative mb-2">
          <img src="assets/images/trophy_2.png" alt="Silver Medal" class="w-[100px] h-auto block mx-auto mb-1">
          <div class="absolute bottom-[18px] left-0 right-0 text-[#fcefed] font-bold text-[10px] text-center">
            {{ rankList[1].points }} {{ TranslateKeys.RANK_POINTS | translate }}
          </div>
        </div>
        <div class="flex items-center gap-2">
          <img [src]="rankList[1].avatar" onError="this.src='https://ionicframework.com/docs/img/demos/avatar.svg'"
               alt="Avatar" class="w-[30px] h-[30px] rounded-full object-cover border border-blue-500 shadow-sm mb-1">
          <div
            class="text-xs font-medium text-gray-800 dark:text-gray-200 whitespace-nowrap overflow-hidden text-ellipsis max-w-[90%]">
            {{ rankList[1].nickname }}
          </div>
        </div>
      </div>

      <div class="flex flex-col items-center text-center w-1/3 transform -translate-y-12" *ngIf="rankList[0]">
        <div class="relative mb-2">
          <img src="assets/images/trophy_1.png" alt="Gold Trophy" class="w-[150px] h-auto block mx-auto mb-1">
          <div class="absolute bottom-[24px] left-0 right-0 text-[#fcefed] font-bold text-[10px] text-center">
            {{ rankList[0].points }} {{ TranslateKeys.RANK_POINTS | translate }}
          </div>
        </div>
        <div class="flex items-center gap-2">
          <img [src]="rankList[0].avatar" onError="this.src='https://ionicframework.com/docs/img/demos/avatar.svg'"
               alt="Avatar" class="w-[30px] h-[30px] rounded-full object-cover border border-blue-500 shadow-sm mb-1">
          <div
            class="text-xs font-medium text-gray-800 dark:text-gray-200 whitespace-nowrap overflow-hidden text-ellipsis max-w-[90%]">
            {{ rankList[0].nickname }}
          </div>
        </div>
      </div>

      <div class="flex flex-col items-center text-center w-1/3" *ngIf="rankList.length > 2 && rankList[2]">
        <div class="relative mb-2">
          <img src="assets/images/trophy_3.png" alt="Bronze Medal" class="w-[100px] h-auto block mx-auto mb-1">
          <div class="absolute bottom-[18px] left-0 right-0 text-[#fcefed] font-bold text-[10px] text-center">
            {{ rankList[2].points }} {{ TranslateKeys.RANK_POINTS | translate }}
          </div>
        </div>
        <div class="flex items-center gap-2">
          <img [src]="rankList[2].avatar" onError="this.src='https://ionicframework.com/docs/img/demos/avatar.svg'"
               alt="Avatar" class="w-[30px] h-[30px] rounded-full object-cover border border-blue-500 shadow-sm mb-1">
          <div
            class="text-xs font-medium text-gray-800 dark:text-gray-200 whitespace-nowrap overflow-hidden text-ellipsis max-w-[90%]">
            {{ rankList[2].nickname }}
          </div>
        </div>
      </div>
    </div>

    <!-- Other ranks -->
    <div class="my-4 flex flex-col h-[calc(100vh-450px)]">
      <div
        class="flex py-2 bg-white dark:bg-gray-800 font-bold text-sm text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-5">
        <div class="w-[15%] text-center">{{ TranslateKeys.RANK_POSITION | translate }}</div>
        <div class="w-[60%] text-left pl-1">{{ TranslateKeys.RANK_NICKNAME | translate }}</div>
        <div class="w-[25%] text-right pr-2.5">{{ TranslateKeys.RANK_POINTS_HEADER | translate }}</div>
      </div>

      <div class="flex-1 overflow-y-auto"
           #rankTableBody
           [class]="shouldShowFixedUserRank() && getCurrentUserRank() ? 'mb-[35px]' : 'mb-[45px]'"
           (scroll)="checkCurrentUserVisibility()">
        <!-- Start loop from the 4th item (index 3) -->
        <div class="flex items-center py-2 px-2.5 border-b border-gray-100 dark:border-gray-700 text-sm"
             [class.bg-blue-400]="item.isCurrentUser"
             [class.text-gray-800]="item.isCurrentUser"
             [class.dark:text-gray-800]="item.isCurrentUser"
             [class.current-user]="item.isCurrentUser"
             *ngFor="let item of rankList.slice(3)"
             [attr.data-user-id]="item.userId">
          <div class="w-[15%] text-center font-medium">{{ item.position }}</div>
          <div class="w-[60%] flex items-center text-left pl-1">
            <img [src]="item.avatar"
                 onError="this.src='https://ionicframework.com/docs/img/demos/avatar.svg'"
                 alt="Avatar"
                 class="w-9 h-9 rounded-full object-cover mr-2.5 border border-blue-500">
            <span class="whitespace-nowrap overflow-hidden text-ellipsis">{{ item.nickname }}</span>
          </div>
          <div class="w-[25%] text-right font-medium pr-1">{{ item.points }}</div>
        </div>
      </div>

      <!-- Fixed current user rank at bottom if position >= 10 and not yet scrolled to that row -->
      <div class="sticky bottom-0 left-0 right-0 z-10 bg-transparent p-0"
           *ngIf="shouldShowFixedUserRank() && getCurrentUserRank()">
        <div class="flex items-center py-2 px-2.5 text-sm bg-blue-400 text-gray-800 my-1">
          <div class="w-[15%] text-center font-medium">{{ getCurrentUserRank()?.position }}</div>
          <div class="w-[60%] flex items-center pl-1">
            <img [src]="getCurrentUserRank()?.avatar"
                 onError="this.src='https://ionicframework.com/docs/img/demos/avatar.svg'"
                 alt="Avatar" class="w-9 h-9 rounded-full object-cover mr-2.5 border border-blue-500">
            <span class="whitespace-nowrap overflow-hidden text-ellipsis">{{ getCurrentUserRank()?.nickname }}</span>
          </div>
          <div class="w-[25%] text-right font-medium pr-1">{{ getCurrentUserRank()?.points }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Achievements content -->
  <div class="text-gray-700 dark:text-gray-300" *ngIf="!isLoading && activeTab === 'achievements'">
    <ion-list>
      <ion-item-group *ngFor="let category of achievements">
        <ion-card class="mx-3 my-3 rounded-xl shadow-md overflow-hidden">
          <ion-card-header class="p-1">
            <ion-card-title class="text-base font-bold p-1 text-gray-800 dark:text-gray-200">{{ category.title }}
            </ion-card-title>
          </ion-card-header>

          <ion-card-content class="p-0 pb-3">
            <ion-grid>
              <ion-row>
                <ion-col size="4" *ngFor="let badge of category.badges">
                  <div
                    class="relative text-center p-1 pt-2 rounded-lg bg-white dark:bg-gray-700 m-1 transition-transform hover:scale-105"
                    [class.opacity-40]="!badge.unlocked"
                    [class.filter-grayscale]="!badge.unlocked">
                    <img [src]="badge.image" class="w-20 h-auto max-h-20 mx-auto block">
                    <ion-badge *ngIf="badge.isNew"
                               class="absolute top-1 p-0.5 px-1 right-1.5 text-xs z-2 bg-red-500 border border-red-100 text-white rounded">
                      {{ TranslateKeys.BADGE_NEW | translate }}
                    </ion-badge>
                    <div
                      class="font-medium mt-0.5 text-xs text-gray-700 dark:text-gray-300 font-comic-sans">{{ badge.name }}
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400" *ngIf="badge.desc">{{ badge.desc }}</div>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>
      </ion-item-group>
    </ion-list>
  </div>
</ion-content>

<app-footer></app-footer>
